name: Deploy to Azure

on:
    push:
        branches:
            - main

permissions:
    contents: read
    id-token: write

jobs:
    deploy:
        runs-on: ubuntu-latest
        env:
            REGISTRY_LOGIN_SERVER: ${{ secrets.AZURE_CONTAINER_REGISTRY }}
            REGISTRY_NAME: ${{ secrets.AZURE_REGISTRY_NAME }}
            WEBAPP_NAME: ${{ secrets.AZURE_WEBAPP_NAME }}
            RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
            IMAGE_NAME: test-task
            TAG: ${{ github.sha }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm

            - name: Install dependencies
              run: npm ci

            - name: Build Next.js project
              run: npm run build -- --no-lint

            - name: Log in to Azure
              uses: azure/login@v2
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS }}

            - name: Log in to container registry
              run: az acr login --name "$REGISTRY_NAME"

            - name: Build container image
              run: |
                  docker build \
                    --tag "$REGISTRY_LOGIN_SERVER/$IMAGE_NAME:$TAG" \
                    --tag "$REGISTRY_LOGIN_SERVER/$IMAGE_NAME:latest" \
                    .

            - name: Push container image
              run: |
                  docker push "$REGISTRY_LOGIN_SERVER/$IMAGE_NAME:$TAG"
                  docker push "$REGISTRY_LOGIN_SERVER/$IMAGE_NAME:latest"

            - name: Update Azure Web App image
              run: |
                  az webapp config container set \
                    --resource-group "$RESOURCE_GROUP" \
                    --name "$WEBAPP_NAME" \
                    --container-image-name "$REGISTRY_LOGIN_SERVER/$IMAGE_NAME:$TAG"

            - name: Restart Azure Web App
              run: az webapp restart --resource-group "$RESOURCE_GROUP" --name "$WEBAPP_NAME"
